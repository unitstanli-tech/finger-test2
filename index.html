<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KDS å»šæˆ¿é¡¯ç¤ºç³»çµ± (æ‹–æ›³æ²å‹•ç‰ˆ)</title>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body {
            font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif;
            margin: 0; padding: 0;
            background-color: #222; 
            color: white;
            display: flex; flex-direction: column;
            height: 100vh; overflow: hidden;
            cursor: none; user-select: none;
        }

        #webcam-container { position: fixed; opacity: 0; pointer-events: none; z-index: -1; }

        /* --- è™›æ“¬æ¸¸æ¨™ (æ°¸é ç½®é ‚) --- */
        #virtual-cursor {
            position: fixed; top: 50%; left: 50%;
            width: 24px; height: 24px;
            background-color: rgba(0, 255, 255, 0.9);
            border: 3px solid white; border-radius: 50%;
            pointer-events: none; z-index: 10000; /* æœ€é«˜å±¤ç´š */
            transform: translate(-50%, -50%); display: none;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
            transition: width 0.1s, height 0.1s, background-color 0.2s, transform 0.1s;
        }
        
        /* æŠ“å–èƒŒæ™¯ (æ‹–æ›³æ¨¡å¼) */
        #virtual-cursor.grabbing {
            background-color: #ffffff; width: 15px; height: 15px;
            box-shadow: 0 0 10px white;
        }

        /* é–å®šæŒ‰éˆ• (é»æ“Šæ¨¡å¼) */
        #virtual-cursor.clicking {
            background-color: #ff0055; width: 20px; height: 20px;
            box-shadow: 0 0 15px #ff0055;
        }

        /* --- é ‚éƒ¨ç‹€æ…‹åˆ— --- */
        header {
            height: 60px; background: #333; display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5); z-index: 100;
        }
        .status-box { display: flex; align-items: center; gap: 10px; }
        .dot { width: 12px; height: 12px; background: #555; border-radius: 50%; }
        .dot.active { background: #0f0; box-shadow: 0 0 10px #0f0; }
        
        /* --- ä¸»ç•«é¢ï¼šå¾…è¾¦è¨‚å–®å€ (æ©«å‘æ²å‹•) --- */
        #orders-track-container {
            flex: 1; 
            overflow: hidden; /* éš±è—åŸç”Ÿæ²è»¸ï¼Œé  JS æ§åˆ¶ */
            position: relative;
            cursor: grab; /* æç¤ºå¯æŠ“å– */
        }

        #orders-track {
            display: flex; 
            align-items: center; 
            gap: 20px; 
            padding: 20px 80px; 
            width: max-content; /* è®“å¯¬åº¦éš¨å…§å®¹æ’é–‹ */
            transition: transform 0.1s ease-out; /* å¹³æ»‘æ²å‹• */
        }

        /* --- è¨‚å–®å¡ç‰‡ --- */
        .order-card {
            min-width: 280px; height: 400px;
            background: #fff; color: #333;
            border-radius: 12px;
            display: flex; flex-direction: column;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s, filter 0.2s;
            border-top: 8px solid #ccc;
            user-select: none;
        }
        .order-card.priority-low { border-top-color: #28a745; }
        .order-card.priority-mid { border-top-color: #ffc107; }
        .order-card.priority-high { border-top-color: #dc3545; }

        .order-card.hovered {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 15px 30px rgba(0,0,0,0.5);
            z-index: 10;
        }
        
        /* è¢«é»æ“Šæ™‚çš„æ•ˆæœ */
        .order-card.pressed {
            transform: scale(0.95);
            filter: brightness(0.9);
        }

        .card-header { padding: 15px; border-bottom: 2px dashed #eee; display: flex; justify-content: space-between; align-items: center; }
        .table-num { font-size: 24px; font-weight: bold; }
        .timer { font-size: 14px; color: #666; font-family: monospace; }
        .card-body { flex: 1; padding: 15px; overflow: hidden; font-size: 18px; line-height: 1.6; }
        .item-row { display: flex; justify-content: space-between; border-bottom: 1px solid #f0f0f0; padding: 5px 0; }
        .card-footer { padding: 15px; background: #f8f9fa; text-align: center; border-radius: 0 0 12px 12px; font-weight: bold; color: #555; }

        /* --- åº•éƒ¨ï¼šå·²å®Œæˆå€ --- */
        #completed-dock {
            height: 120px; background: #2a2a2a; border-top: 1px solid #444;
            display: flex; align-items: center; padding: 0 20px; gap: 15px;
            overflow-x: auto; z-index: 100;
        }
        .mini-ticket {
            min-width: 80px; height: 80px; background: #444; color: #aaa;
            border-radius: 8px; display: flex; flex-direction: column;
            justify-content: center; align-items: center; font-size: 12px;
            border-left: 4px solid #28a745; opacity: 0.6;
        }

        /* --- Modal è©³æƒ…èˆ‡å®Œæˆ --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none;
            justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-card {
            width: 500px; background: white; color: #333; border-radius: 15px; overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            display: flex; flex-direction: column;
        }
        .modal-items { padding: 30px; font-size: 22px; max-height: 40vh; overflow-y: auto; }
        
        .action-bar { display: flex; height: 100px; }
        .btn-close { flex: 1; background: #e9ecef; border: none; font-size: 24px; color: #333; }
        .btn-complete { flex: 2; background: #28a745; border: none; font-size: 28px; color: white; font-weight: bold; position: relative; overflow: hidden; }
        
        .btn-progress {
            position: absolute; left: 0; top: 0; bottom: 0; width: 0%; 
            background: rgba(0,0,0,0.2); transition: width 0.05s linear; pointer-events: none;
        }
        
        .btn-close.hovered { background: #d3d9df; }
        .btn-complete.hovered { filter: brightness(1.1); }
        .btn-complete.active { transform: scale(0.98); }

        /* å‡ºé¤å‹•ç•« */
        .flying-ticket {
            position: fixed; z-index: 5000; background: white; 
            border: 2px solid #28a745; border-radius: 10px;
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 20px; color: #28a745;
        }

        /* æ“ä½œæç¤º */
        .hint-overlay {
            position: absolute; bottom: 140px; width: 100%; text-align: center;
            color: rgba(255,255,255,0.4); font-size: 14px; pointer-events: none;
        }
    </style>
</head>
<body>

    <header>
        <div style="font-size: 24px; font-weight: bold;">ğŸ§‘â€ğŸ³ KDS å»šæˆ¿é¡¯ç¤ºç³»çµ±</div>
        <div class="status-box">
            <div id="status-text">ç³»çµ±è¼‰å…¥ä¸­...</div>
            <div class="dot" id="status-dot"></div>
        </div>
    </header>

    <!-- è¨‚å–®è»Œé“å®¹å™¨ -->
    <div id="orders-track-container">
        <div id="orders-track">
            <!-- JS ç”Ÿæˆè¨‚å–® -->
        </div>
    </div>
    
    <div class="hint-overlay">
        ğŸ‘Œ æåˆèƒŒæ™¯å·¦å³æ‹–æ›³å¯æ²å‹• &nbsp;|&nbsp; ğŸ‘Œ è¼•æè¨‚å–®å³å¯é–‹å•Ÿ
    </div>

    <!-- åº•éƒ¨å·²å®Œæˆå€ -->
    <div id="completed-dock">
        <div style="color: #666; font-style: italic;">å·²å®Œæˆè¨‚å–®å€</div>
    </div>

    <!-- è©³æƒ… Modal -->
    <div class="modal-overlay" id="order-modal">
        <div class="modal-card">
            <div class="card-header" style="background: #f8f9fa;">
                <span class="table-num" id="modal-title">Table</span>
                <span class="timer" id="modal-time">Time</span>
            </div>
            <div class="modal-items" id="modal-content"></div>
            <div class="action-bar">
                <button class="btn-close interactive" id="btn-cancel">è¿”å›</button>
                <button class="btn-complete interactive" id="btn-complete">
                    <div class="btn-progress" id="btn-prog"></div>
                    <span>é•·æå‡ºé¤</span>
                </button>
            </div>
        </div>
    </div>

    <div id="webcam-container">
        <video id="webcam" autoplay playsinline></video>
    </div>

    <div id="virtual-cursor"></div>

    <script type="module">
        import { FilesetResolver, HandLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js";

        // --- åƒæ•¸è¨­å®š ---
        const PINCH_THRESHOLD = 0.06;   // æåˆè§¸ç™¼é–€æª»
        const LOCK_THRESHOLD = 0.1;     // é–å®š/è§£é–é–€æª»
        const LONG_PRESS_TIME = 800;    // å®Œæˆè¨‚å–®éœ€è¦æå¤šä¹…
        const CLICK_TIMEOUT = 300;      // è¼•æé»æ“Šçš„åˆ¤å®šæ™‚é–“ (å°æ–¼é€™å€‹æ™‚é–“ç®— Click)
        
        // æ²å‹•åƒæ•¸
        const SCROLL_SENSITIVITY = 1.5; // æ‹–æ›³éˆæ•åº¦

        // --- ç‹€æ…‹è®Šæ•¸ ---
        let orders = [];
        let completedOrders = [];
        let currentModalOrder = null;

        // æ‰‹å‹¢ç›¸é—œ
        let smoothX = 0.5, smoothY = 0.5;
        let pinchState = false; // true = æåˆä¸­
        let pinchStartTime = 0;
        let startPinchX = 0; // æåˆé–‹å§‹æ™‚çš„ X åº§æ¨™ (ç”¨æ–¼æ‹–æ›³)
        let scrollStartX = 0; // æåˆé–‹å§‹æ™‚çš„æ²å‹•ä½ç½®

        let hoveredElement = null;
        let isInputPaused = false;
        
        // æ²å‹•ç›¸é—œ
        let currentScroll = 0;
        const trackContainer = document.getElementById('orders-track-container');

        // --- 1. è¨‚å–®ç”¢ç”Ÿé‚è¼¯ ---
        function generateMockOrders(count = 6) {
            const itemsPool = ["å‡±è–©æ²™æ‹‰", "è˜‘è‡æ¿ƒæ¹¯", "ç´ç´„å®¢ç‰›æ’", "æ¾éœ²ç‡‰é£¯", "ç‚¸é­šè–¯æ¢", "å¯æ¨‚", "ç†±ç¾å¼", "ææ‹‰ç±³è˜‡"];
            for (let i = 0; i < count; i++) {
                const itemCount = Math.floor(Math.random() * 4) + 1;
                const items = [];
                for(let j=0; j<itemCount; j++) {
                    items.push({ name: itemsPool[Math.floor(Math.random() * itemsPool.length)], qty: 1 });
                }
                const minutesAgo = Math.floor(Math.random() * 25) + 1;
                const date = new Date(Date.now() - minutesAgo * 60000);
                const timeStr = `${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;

                orders.push({
                    id: `ord-${Date.now()}-${i}`,
                    table: Math.floor(Math.random() * 20) + 1,
                    timeStr: timeStr,
                    timestamp: date.getTime(),
                    items: items,
                });
            }
            renderOrders();
        }

        function renderOrders() {
            const track = document.getElementById('orders-track');
            track.innerHTML = '';
            orders.sort((a, b) => a.timestamp - b.timestamp);

            orders.forEach(order => {
                const now = Date.now();
                const diffMins = (now - order.timestamp) / 60000;
                let priorityClass = 'priority-low';
                if (diffMins > 10) priorityClass = 'priority-mid';
                if (diffMins > 20) priorityClass = 'priority-high';

                const card = document.createElement('div');
                card.className = `order-card interactive ${priorityClass}`;
                card.id = order.id;
                
                let itemsHtml = order.items.map(it => 
                    `<div class="item-row"><span>${it.name}</span><span>x${it.qty}</span></div>`
                ).join('');

                card.innerHTML = `
                    <div class="card-header">
                        <span class="table-num">T-${order.table}</span>
                        <span class="timer">${order.timeStr}</span>
                    </div>
                    <div class="card-body">${itemsHtml}</div>
                    <div class="card-footer">è¼•æé–‹å•Ÿ</div>
                `;
                track.appendChild(card);
            });
            
            // ä¿®æ­£å®¹å™¨å¯¬åº¦
            track.style.width = `${orders.length * 300 + 100}px`; 
        }

        // --- 2. MediaPipe ---
        let handLandmarker = undefined;
        async function startApp() {
            try {
                const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
                handLandmarker = await HandLandmarker.createFromOptions(vision, {
                    baseOptions: {
                        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",
                        delegate: "GPU"
                    },
                    runningMode: "VIDEO",
                    numHands: 1
                });
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
                const video = document.getElementById("webcam");
                video.srcObject = stream;
                video.addEventListener("loadeddata", () => {
                    document.getElementById("status-dot").classList.add("active");
                    document.getElementById("status-text").innerText = "Air Mouse é‹ä½œä¸­";
                    generateMockOrders();
                    predictWebcam();
                });
            } catch (err) {
                console.error(err);
                alert("ç›¸æ©Ÿå­˜å–å¤±æ•—");
            }
        }
        startApp();

        // --- 3. ä¸»è¿´åœˆ ---
        async function predictWebcam() {
            const video = document.getElementById("webcam");
            let startTimeMs = performance.now();
            window.requestAnimationFrame(predictWebcam);

            if (handLandmarker && video.currentTime > 0) {
                const results = handLandmarker.detectForVideo(video, startTimeMs);
                if (results.landmarks.length > 0) {
                    const lm = results.landmarks[0];
                    // è¨ˆç®—æåˆè·é›¢
                    const pinchDist = Math.sqrt(Math.pow(lm[8].x - lm[4].x, 2) + Math.pow(lm[8].y - lm[4].y, 2));
                    
                    // A. æ›´æ–°æ¸¸æ¨™ä½ç½®
                    updateCursor(lm[8].x, lm[8].y);

                    if (!isInputPaused) {
                        // B. æª¢æŸ¥æ‡¸åœ (å¦‚æœä¸åœ¨æåˆæ‹–æ›³ç‹€æ…‹)
                        if (!pinchState) checkHover();
                        
                        // C. è™•ç†äº’å‹•é‚è¼¯
                        handleInteraction(pinchDist);
                    }
                } else {
                    document.getElementById('virtual-cursor').style.display = 'none';
                    clearHover();
                }
            }
        }

        // --- 4. æ¸¸æ¨™é‚è¼¯ ---
        function updateCursor(rawX, rawY) {
            const cursor = document.getElementById('virtual-cursor');
            
            // é¡åƒç¿»è½‰ + æ˜ å°„ç¯„åœ (è®“æ‰‹ä¸ç”¨ä¼¸åˆ°è¢å¹•é‚Šç·£)
            let x = 1 - rawX;
            let y = rawY;
            
            x = (x - 0.1) / 0.8; 
            y = (y - 0.1) / 0.8;
            x = Math.max(0, Math.min(1, x));
            y = Math.max(0, Math.min(1, y));

            smoothX = smoothX * 0.8 + x * 0.2;
            smoothY = smoothY * 0.8 + y * 0.2;

            cursor.style.display = 'block';
            cursor.style.left = `${smoothX * window.innerWidth}px`;
            cursor.style.top = `${smoothY * window.innerHeight}px`;

            // ç‹€æ…‹æ¨£å¼
            cursor.className = ''; // reset
            if (pinchState) {
                if (hoveredElement) cursor.classList.add('clicking'); // æœ‰ç›®æ¨™ï¼šé»æ“Šæ¨¡å¼ (ç´…)
                else cursor.classList.add('grabbing'); // ç„¡ç›®æ¨™ï¼šæ‹–æ›³æ¨¡å¼ (ç™½)
            }
        }

        function checkHover() {
            const cursor = document.getElementById('virtual-cursor');
            const rect = cursor.getBoundingClientRect();
            // åµæ¸¬ä¸­å¿ƒé»
            const el = document.elementFromPoint(rect.left + rect.width/2, rect.top + rect.height/2);
            if (!el) return;
            
            const interactiveEl = el.closest('.interactive');
            if (interactiveEl !== hoveredElement) {
                clearHover();
                if (interactiveEl) {
                    interactiveEl.classList.add('hovered');
                    hoveredElement = interactiveEl;
                }
            }
        }

        function clearHover() {
            if (hoveredElement) {
                hoveredElement.classList.remove('hovered');
                hoveredElement = null;
            }
        }

        // --- 5. æ ¸å¿ƒäº’å‹•é‚è¼¯ (æ‹–æ›³èˆ‡é»æ“Šåˆ†é›¢) ---
        function handleInteraction(distance) {
            // --- ç‹€æ…‹ 1: é–‹å§‹æåˆ ---
            if (distance < PINCH_THRESHOLD) {
                if (!pinchState) {
                    // å‰›é–‹å§‹æåˆ (Touch Down)
                    pinchState = true;
                    pinchStartTime = Date.now();
                    startPinchX = smoothX;
                    scrollStartX = trackContainer.scrollLeft;
                    
                    // å¦‚æœæŒ‰åœ¨å¡ç‰‡ä¸Šï¼Œçµ¦äºˆè¦–è¦ºå›é¥‹
                    if (hoveredElement) hoveredElement.classList.add('pressed');
                }

                // æŒçºŒæåˆä¸­ (Holding / Dragging)
                const elapsed = Date.now() - pinchStartTime;

                if (hoveredElement) {
                    // === æƒ…å¢ƒ A: åœ¨ç‰©ä»¶ä¸Šæåˆ (æ„åœ–ï¼šé»æ“Šæˆ–é•·æŒ‰) ===
                    
                    // å¦‚æœæ˜¯å®ŒæˆæŒ‰éˆ•ï¼Œé¡¯ç¤ºé€²åº¦æ¢
                    if (hoveredElement.id === 'btn-complete') {
                        const progress = Math.min((elapsed / LONG_PRESS_TIME) * 100, 100);
                        document.getElementById('btn-prog').style.width = `${progress}%`;
                        
                        if (elapsed > LONG_PRESS_TIME) {
                            // é•·æŒ‰æ™‚é–“åˆ°ï¼Œè§¸ç™¼å®Œæˆ
                            triggerAction(hoveredElement);
                            forceRelease(); // å¼·åˆ¶é‡ç½®
                        }
                    } 
                    // å¦‚æœæ˜¯å¡ç‰‡ï¼Œä¸éœ€è¦é€²åº¦æ¢ï¼Œç­‰å¾…æ”¾é–‹æ™‚è§¸ç™¼ (Click)
                } 
                else {
                    // === æƒ…å¢ƒ B: åœ¨èƒŒæ™¯æåˆ (æ„åœ–ï¼šæ‹–æ›³æ²å‹•) ===
                    // è¨ˆç®—ä½ç§»é‡
                    const deltaX = (smoothX - startPinchX) * window.innerWidth * SCROLL_SENSITIVITY;
                    trackContainer.scrollLeft = scrollStartX - deltaX;
                }

            } else {
                // --- ç‹€æ…‹ 2: æ”¾é–‹æ‰‹æŒ‡ (Touch Up) ---
                if (distance > LOCK_THRESHOLD && pinchState) {
                    // å‰›æ”¾é–‹
                    const elapsed = Date.now() - pinchStartTime;
                    
                    // åˆ¤æ–·æ˜¯å¦ç‚ºã€Œè¼•é» (Click)ã€
                    if (hoveredElement && elapsed < CLICK_TIMEOUT) {
                        // æ˜¯è¼•é»ï¼Œè§¸ç™¼å‹•ä½œ
                        triggerAction(hoveredElement);
                    }

                    // é‡ç½®æ‰€æœ‰ç‹€æ…‹
                    forceRelease();
                }
            }
        }

        function forceRelease() {
            pinchState = false;
            if (hoveredElement) hoveredElement.classList.remove('pressed');
            document.getElementById('btn-prog').style.width = "0%";
        }

        function triggerAction(el) {
            const id = el.id;

            // 1. é»æ“Šè¨‚å–® -> é–‹å•Ÿè©³æƒ…
            if (el.classList.contains('order-card')) {
                openOrderModal(id);
            }
            // 2. é»æ“Šé—œé–‰
            else if (id === 'btn-cancel') {
                closeModal();
            }
            // 3. é•·æŒ‰å®Œæˆ (ç”±ä¸Šæ–¹ timer è§¸ç™¼ï¼Œé€™è£¡é€šå¸¸ä¸è§¸ç™¼ï¼Œé™¤éè¨­è¨ˆæˆé»æ“Šå³å®Œæˆ)
            else if (id === 'btn-complete') {
                completeOrder();
            }
        }

        // --- 6. æ¥­å‹™é‚è¼¯ ---
        function openOrderModal(orderId) {
            currentModalOrder = orders.find(o => o.id === orderId);
            if (!currentModalOrder) return;

            document.getElementById('modal-title').innerText = `Table ${currentModalOrder.table}`;
            document.getElementById('modal-time').innerText = currentModalOrder.timeStr;
            const content = document.getElementById('modal-content');
            content.innerHTML = currentModalOrder.items.map(it => 
                `<div class="item-row"><span>${it.name}</span><span>${it.qty}</span></div>`
            ).join('');

            document.getElementById('order-modal').style.display = 'flex';
            tempPauseInput(); // æš«åœä¸€ä¸‹é˜²æ­¢èª¤è§¸
        }

        function closeModal() {
            document.getElementById('order-modal').style.display = 'none';
            currentModalOrder = null;
        }

        function completeOrder() {
            if (!currentModalOrder) return;
            const orderId = currentModalOrder.id;
            
            closeModal();

            // å‹•ç•«
            const card = document.getElementById(orderId);
            if (card) {
                const rect = card.getBoundingClientRect();
                const flyer = document.createElement('div');
                flyer.className = 'flying-ticket';
                flyer.style.left = `${rect.left}px`;
                flyer.style.top = `${rect.top}px`;
                flyer.style.width = `${rect.width}px`;
                flyer.style.height = `${rect.height}px`;
                flyer.innerText = "COMPLETED!";
                document.body.appendChild(flyer);

                const dock = document.getElementById('completed-dock');
                const dockRect = dock.getBoundingClientRect();

                requestAnimationFrame(() => {
                    flyer.style.transform = `translate(${dockRect.left - rect.left}px, ${dockRect.top - rect.top}px) scale(0.2)`;
                    flyer.style.opacity = '0';
                });

                // ç§»é™¤è³‡æ–™
                orders = orders.filter(o => o.id !== orderId);
                
                card.style.opacity = '0';
                setTimeout(() => {
                    renderOrders();
                    flyer.remove();
                    
                    // åŠ åˆ°ä¸‹æ–¹
                    const mini = document.createElement('div');
                    mini.className = 'mini-ticket';
                    mini.innerHTML = `<span>T-${currentModalOrder.table}</span><span>Done</span>`;
                    document.getElementById('completed-dock').prepend(mini);
                }, 600);
            }
        }

        function tempPauseInput() {
            isInputPaused = true;
            forceRelease();
            setTimeout(() => isInputPaused = false, 300);
        }

    </script>
</body>
</html>